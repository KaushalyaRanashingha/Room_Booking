<!DOCTYPE html>
<html>
<head>
  <title>Payments</title>

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <link rel="stylesheet" href="/admin.css">
</head>

<body class="bg-light">
<div class="d-flex min-vh-100">

  <%- include("sidebar") %>

  <div class="flex-grow-1 d-flex flex-column">
    <%- include("navbar") %>

    <main class="container-fluid py-3">

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-end mb-3">
        <div>
          <h1 class="h3 mb-1">Payments</h1>
          <p class="text-muted mb-0">Manage customer payments</p>
        </div>
        <span class="badge bg-light text-muted border">
          Total: <%= payments.length %>
        </span>
      </div>

      <!-- Table -->
      <div class="card shadow-sm">
        <div class="card-body">

          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th>User</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>

              <tbody>
              <% if (payments.length === 0) { %>
                <tr>
                  <td colspan="4" class="text-center text-muted py-4">
                    No payments found
                  </td>
                </tr>
              <% } %>

              <% payments.forEach(p => { %>
                <tr>
                  <td><%= p.user?.name || "—" %></td>
                  <td>LKR <%= p.amount %></td>

                  <td>
                    <% if (p.status === "Paid") { %>
                      <span class="badge bg-success">Paid</span>
                    <% } else if (p.status === "Pending") { %>
                      <span class="badge bg-warning text-dark">Pending</span>
                    <% } else { %>
                      <span class="badge bg-danger">Failed</span>
                    <% } %>
                  </td>

                  <td>
                    <% if (p.status === "Pending") { %>
                      <button
                        class="btn btn-sm btn-success approve-btn"
                        data-id="<%= p._id %>">
                        Approve
                      </button>
                    <% } else { %>
                      —
                    <% } %>
                  </td>
                </tr>
              <% }) %>
              </tbody>
            </table>
          </div>

        </div>
      </div>

    </main>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
document.querySelectorAll(".approve-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const paymentId = btn.dataset.id;

    if (!confirm("Approve this payment?")) return;

    try {
      const res = await axios.post(
        `/api/admin/payment/approve/${paymentId}`
      );

      alert(res.data.message || "Payment approved");

      // UI update
      btn.closest("tr").querySelector("td:nth-child(3)").innerHTML =
        '<span class="badge bg-success">Paid</span>';

      btn.remove();

    } catch (err) {
      console.error(err);
      alert(err.response?.data?.error || "Failed to approve payment");
    }
  });
});
</script>

</body>
</html>
